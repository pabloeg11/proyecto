---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import ReviewCard from "../../components/ReviewCard.astro";
import {
  getCategoryBySlug,
  getReviews,
  getStrapiMediaUrl,
  getFirstCategory,
} from "../../lib/api";

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect("/categories/");
}

let category = null;
let reviews = null;
let error = "";

try {
  category = await getCategoryBySlug(slug);
} catch (e) {
  console.error("category/[slug]: getCategoryBySlug failed", e);
  error = "no se pudo cargar la categoría.";
}

try {
  reviews = await getReviews({ categorySlug: slug, page: 1, pageSize: 12, sortBy: "date" });
} catch (e) {
  console.error("category/[slug]: getReviews failed", e);
  error = error || "no se pudieron cargar las reseñas.";
}

const catAttr = category?.attributes;
const catName = catAttr?.name ?? slug;
const catDesc = catAttr?.description ?? "";
const catImage = getStrapiMediaUrl(catAttr?.image) ?? "/images/placeholder.jpg";

const items = reviews?.data ?? [];
---

<Layout
  title={catName}
  description={catDesc || `Reseñas de la categoría ${catName} en ZonaReseñas.`}
>
  <section class="section">
    <div class="container">
      <div class="mb-10">
        <div class="flex items-start gap-6">
          <div class="w-24 h-24 rounded-xl overflow-hidden border border-border shrink-0">
            <img src={catImage} alt={`Categoría: ${catName}`} class="w-full h-full object-cover" loading="lazy" decoding="async" />
          </div>
          <div>
            <span class="inline-block badge bg-primary/10 text-primary mb-2 font-sans uppercase tracking-wider text-xs">
              categoría
            </span>
            <h1 class="font-serif text-3xl md:text-4xl font-bold text-foreground mb-2">
              {catName}
            </h1>
            {catDesc && <p class="text-muted-foreground font-sans max-w-2xl">{catDesc}</p>}
          </div>
        </div>
      </div>

      {error ? (
        <div class="text-center py-16">
          <p class="text-destructive text-lg">{error}</p>
        </div>
      ) : items.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {items
            .filter((r) => r?.attributes?.slug)
            .map((r) => {
              const a = r.attributes;
              const cat = getFirstCategory(a.categories ?? a.category);
              const coverUrl = getStrapiMediaUrl(a.cover ?? a.image) ?? "/images/placeholder.jpg";

              return (
                <ReviewCard
                  title={a.title ?? "sin título"}
                  slug={a.slug ?? ""}
                  excerpt={a.excerpt ?? ""}
                  rating={Number(a.rating ?? 0)}
                  category={cat.slug}
                  categoryLabel={cat.name}
                  image={coverUrl}
                  author={a.author ?? "anónimo"}
                  publishedAt={a.publishedAt ?? new Date().toISOString()}
                  genre={a.genre ?? ""}
                />
              );
            })}
        </div>
      ) : (
        <div class="text-center py-16">
          <p class="text-muted-foreground">no hay reseñas en esta categoría todavía.</p>
          <a href="/reviews/" class="btn btn-primary mt-4">ver todas las reseñas</a>
        </div>
      )}
    </div>
  </section>
</Layout>
