---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import ReviewCard from "../../components/ReviewCard.astro";
import { getReviews } from "../../lib/api";

const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL ?? "http://localhost:1337";

function getStrapiMediaUrl(media: any) {
  const url = media?.data?.attributes?.url;
  if (!url) return null;
  return url.startsWith("http") ? url : `${STRAPI_URL}${url}`;
}

const { slug } = Astro.params;

let reviewsRes: any = null;
let category: any = null;
let error = "";

try {
  // 1) cargar la categoría por slug
  const catRes = await fetch(
    `${STRAPI_URL}/api/categories?filters[slug][$eq]=${encodeURIComponent(slug as string)}&populate=*`
  );
  const catJson = await catRes.json();
  category = catJson?.data?.[0]?.attributes;

  if (!category) return Astro.redirect("/404");

  // 2) cargar reviews filtradas por esa categoría
  reviewsRes = await getReviews({
  category: String(slug),
  sortBy: "date",
  page: 1,
  pageSize: 50,
} as any);
} catch (e) {
  error = "no se pudieron cargar las reseñas de esta categoría.";
}
reviewsRes = await getReviews({
  categorySlug: String(slug),
  sortBy: "date",
  page: 1,
  pageSize: 50,
});

const reviewList = reviewsRes?.data ?? [];
const title = category?.seo?.metaTitle || `${category?.name ?? "categoría"} | zona reseñas`;
const description = category?.seo?.metaDescription || category?.description || "";
const heroImg = getStrapiMediaUrl(category?.image) || "/images/placeholder.jpg";
---

<Layout title={title} description={description}>
  <section class="relative overflow-hidden">
    <div class="aspect-[4/1] max-h-72">
      <img src={heroImg} alt={`categoría: ${category?.name ?? ""}`} class="w-full h-full object-cover" />
    </div>
    <div class="absolute inset-0 bg-gradient-to-t from-background via-background/60 to-transparent"></div>
    <div class="absolute bottom-0 left-0 right-0">
      <div class="container pb-8">
        <h1 class="font-serif text-3xl md:text-4xl lg:text-5xl font-bold text-foreground mb-2 text-balance">
          {category?.name}
        </h1>
        <p class="text-muted-foreground font-sans max-w-xl">{category?.description}</p>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      {error && <p class="text-destructive text-lg">{error}</p>}

      {!error && reviewList.length === 0 && (
        <p class="text-muted-foreground">no hay reseñas en esta categoría todavía.</p>
      )}

      {!error && reviewList.length > 0 && (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {reviewList.map((item: any) => {
            const r = item.attributes ?? {};
            const coverUrl = getStrapiMediaUrl(r.cover) || "/images/placeholder.jpg";
            const catName = (r.categories?.data ?? [])?.[0]?.attributes?.name ?? category?.name ?? "";
            const catSlug = (r.categories?.data ?? [])?.[0]?.attributes?.slug ?? slug ?? "";

            return (
              <ReviewCard
                title={r.title}
                slug={r.slug}
                excerpt={r.excerpt}
                rating={r.rating}
                category={catSlug}
                categoryLabel={catName}
                image={coverUrl}
                author={r.author || "zona reseñas"}
                publishedAt={r.publishedAt || r.publishedDate || new Date().toISOString()}
                genre={r.genre}
              />
            );
          })}
        </div>
      )}
    </div>
  </section>
</Layout>