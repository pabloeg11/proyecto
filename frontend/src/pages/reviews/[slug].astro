---
import Layout from '../../layouts/Layout.astro';
import ReviewCard from '../../components/ReviewCard.astro';
import { getReviewBySlug, getRelatedReviews, formatDate, calculateReadingTime } from '../../lib/api';
import { reviewsData } from '../../lib/mockData';
import { ROLES } from '../../lib/roles';

// Generación de rutas estáticas
export async function getStaticPaths() {
  return reviewsData.map(({ attributes }) => ({
    params: { slug: attributes.slug },
  }));
}

const { slug } = Astro.params;
let review, relatedReviews;
let error = '';

try {
  review = await getReviewBySlug(slug as string);

  if (!review) {
    return Astro.redirect('/404');
  }

  relatedReviews = await getRelatedReviews(
    review.attributes.slug,
    review.attributes.category,
    3
  );
} catch (e) {
  error = 'No se pudo cargar la reseña.';
}

const {
  title,
  excerpt,
  content,
  rating,
  category,
  categoryLabel,
  image,
  author,
  publishedAt,
  director,
  platform,
  genre,
  year,
  seo,
  comments,
} = review?.attributes || {};

const readingTime = content ? calculateReadingTime(content) : 0;

const categoryColors: Record<string, string> = {
  peliculas: 'bg-blue-500/10 text-blue-600 dark:text-blue-400',
  series: 'bg-emerald-500/10 text-emerald-600 dark:text-emerald-400',
  videojuegos: 'bg-orange-500/10 text-orange-600 dark:text-orange-400',
};

const ratingColor =
  rating >= 9
    ? 'text-green-500'
    : rating >= 7
      ? 'text-primary'
      : rating >= 5
        ? 'text-yellow-500'
        : 'text-red-500';
---

<Layout
  title={seo?.metaTitle || title || 'Reseña'}
  description={seo?.metaDescription || excerpt}
>
  {error ? (
    <section class="section">
      <div class="container text-center">
        <p class="text-destructive text-lg">{error}</p>
      </div>
    </section>
  ) : review ? (
    <>
      <!-- Hero Image -->
      <div class="relative h-64 md:h-96 overflow-hidden">
        <img
          src={image}
          alt={`Imagen de portada de ${title}`}
          class="w-full h-full object-cover"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-background via-background/50 to-transparent"></div>
      </div>

      <article class="section -mt-24 relative z-10">
        <div class="container">
          <div class="max-w-4xl mx-auto">
            <!-- Article Header -->
            <header class="mb-10">
              <div class="flex flex-wrap items-center gap-3 mb-4">
                <span class={`badge ${categoryColors[category] || ''}`}>
                  {categoryLabel}
                </span>
                <span class="badge bg-secondary text-secondary-foreground">{genre}</span>
                <span class="badge bg-secondary text-secondary-foreground">{year}</span>
                {director && (
                  <span class="badge bg-secondary text-secondary-foreground">Dir: {director}</span>
                )}
                {platform && (
                  <span class="badge bg-secondary text-secondary-foreground">{platform}</span>
                )}
              </div>

              <h1 class="font-serif text-3xl md:text-4xl lg:text-5xl font-bold text-foreground mb-4 text-balance">
                {title}
              </h1>

              <p class="text-lg text-muted-foreground leading-relaxed mb-6 text-pretty">
                {excerpt}
              </p>

              <!-- Meta info -->
              <div class="flex flex-wrap items-center gap-4 text-sm text-muted-foreground font-sans pb-6 border-b border-border">
                <span>Por <strong class="text-foreground">{author}</strong></span>
                <span>|</span>
                <time datetime={publishedAt}>{formatDate(publishedAt)}</time>
                <span>|</span>
                <span>{readingTime} min de lectura</span>
                <span>|</span>
                <span class={`text-2xl font-bold ${ratingColor}`}>{rating.toFixed(1)}</span>
                <span class="text-xs text-muted-foreground">/ 10</span>
              </div>
            </header>

            <!-- Rating display visual -->
            <div class="bg-card border border-border rounded-xl p-6 mb-10">
              <div class="flex items-center justify-between mb-3">
                <h2 class="font-sans font-semibold text-sm uppercase tracking-wider text-foreground">Puntuación ZonaReseñas</h2>
                <span class={`text-4xl font-bold font-sans ${ratingColor}`}>{rating.toFixed(1)}</span>
              </div>
              <div class="w-full bg-muted rounded-full h-3 overflow-hidden">
                <div
                  class="h-full rounded-full bg-primary transition-all duration-500"
                  style={`width: ${(rating / 10) * 100}%`}
                ></div>
              </div>
              <div class="flex justify-between mt-2 text-xs text-muted-foreground font-sans">
                <span>0</span>
                <span>5</span>
                <span>10</span>
              </div>
            </div>

            <!-- Article Content -->
            <div class="prose-content mb-16">
              <Fragment set:html={content} />
            </div>

            <!-- User Rating Section -->
            <div class="bg-card border border-border rounded-xl p-6 mb-10" id="user-rating-section">
              <h2 class="font-serif text-xl font-bold text-foreground mb-4">Valora esta reseña</h2>
              <p class="text-sm text-muted-foreground font-sans mb-4">
                Tu valoración suma puntos para tu rango. Rango actual: <span id="current-role-badge" class="badge bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400">Novato</span>
              </p>
              <div class="flex items-center gap-1 mb-4" id="star-rating" role="radiogroup" aria-label="Valoración del 1 al 10">
                {Array.from({ length: 10 }, (_, i) => (
                  <button
                    type="button"
                    class="star-btn w-8 h-8 rounded-full flex items-center justify-center text-lg transition-colors hover:bg-primary/10 star-empty"
                    data-value={i + 1}
                    aria-label={`${i + 1} de 10 estrellas`}
                  >
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                  </button>
                ))}
                <span id="rating-display" class="ml-3 text-sm text-muted-foreground font-sans">Selecciona tu puntuación</span>
              </div>
              <button id="submit-rating" class="btn btn-primary" disabled>
                Enviar valoración
              </button>
              <div id="rating-feedback" class="mt-3 text-sm font-sans hidden"></div>
            </div>

            <!-- Comments Section -->
            <section class="mb-16" aria-labelledby="comments-heading">
              <h2 id="comments-heading" class="font-serif text-2xl font-bold text-foreground mb-6">
                Comentarios ({comments?.length || 0})
              </h2>

              <!-- Comment Form -->
              <div class="bg-card border border-border rounded-xl p-6 mb-8">
                <h3 class="font-sans font-semibold text-foreground mb-4">Deja tu comentario</h3>
                <form id="comment-form" class="flex flex-col gap-4">
                  <div>
                    <label for="comment-name" class="block text-sm font-medium text-foreground mb-1 font-sans">Nombre</label>
                    <input
                      id="comment-name"
                      type="text"
                      placeholder="Tu nombre"
                      required
                      class="w-full px-4 py-2.5 rounded-lg border border-border bg-background text-foreground text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring font-sans"
                    />
                    <p id="name-error" class="text-xs text-destructive mt-1 hidden font-sans"></p>
                  </div>
                  <div>
                    <label for="comment-content" class="block text-sm font-medium text-foreground mb-1 font-sans">Comentario</label>
                    <textarea
                      id="comment-content"
                      placeholder="Comparte tu opinión sobre esta reseña..."
                      rows="4"
                      required
                      class="w-full px-4 py-2.5 rounded-lg border border-border bg-background text-foreground text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring font-sans resize-y"
                    ></textarea>
                    <p id="content-error" class="text-xs text-destructive mt-1 hidden font-sans"></p>
                  </div>
                  <div class="flex items-center justify-between">
                    <button type="submit" class="btn btn-primary">
                      Publicar comentario
                    </button>
                    <span class="text-xs text-muted-foreground font-sans">+5 puntos por comentario</span>
                  </div>
                  <div id="comment-feedback" class="text-sm font-sans hidden"></div>
                </form>
              </div>

              <!-- Existing Comments -->
              <div id="comments-list" class="flex flex-col gap-4">
                {comments && comments.length > 0 ? (
                  comments.map((comment) => (
                    <div class="bg-card border border-border rounded-xl p-5 comment-item">
                      <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                          <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-sm font-bold text-primary font-sans">
                            {comment.author.charAt(0).toUpperCase()}
                          </div>
                          <div>
                            <span class="text-sm font-semibold text-foreground font-sans">{comment.author}</span>
                            <time class="block text-xs text-muted-foreground font-sans" datetime={comment.date}>
                              {formatDate(comment.date)}
                            </time>
                          </div>
                        </div>
                        {comment.rating > 0 && (
                          <div class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-primary" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            <span class="text-sm font-bold text-primary font-sans">{comment.rating}</span>
                          </div>
                        )}
                      </div>
                      <p class="text-sm text-muted-foreground leading-relaxed">{comment.content}</p>
                    </div>
                  ))
                ) : (
                  <p class="text-center text-muted-foreground py-8 font-sans">
                    Aún no hay comentarios. Sé el primero en opinar.
                  </p>
                )}
              </div>
            </section>

            <!-- Related Reviews -->
            {relatedReviews && relatedReviews.length > 0 && (
              <section aria-labelledby="related-heading">
                <h2 id="related-heading" class="font-serif text-2xl font-bold text-foreground mb-6">
                  Reseñas relacionadas
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  {relatedReviews.map(({ attributes: rel }) => (
                    <ReviewCard
                      title={rel.title}
                      slug={rel.slug}
                      excerpt={rel.excerpt}
                      rating={rel.rating}
                      category={rel.category}
                      categoryLabel={rel.categoryLabel}
                      image={rel.image}
                      author={rel.author}
                      publishedAt={rel.publishedAt}
                      genre={rel.genre}
                    />
                  ))}
                </div>
              </section>
            )}
          </div>
        </div>
      </article>
    </>
  ) : null}
</Layout>

<!-- Prose/content styles -->
<style>
  .prose-content {
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 1.0625rem;
    line-height: 1.75;
    color: var(--color-foreground);
  }

  .prose-content :global(h2) {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 1.5rem;
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    color: var(--color-foreground);
  }

  .prose-content :global(h3) {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: var(--color-foreground);
  }

  .prose-content :global(p) {
    margin-bottom: 1.25rem;
    color: var(--color-muted-foreground);
  }

  .prose-content :global(strong) {
    color: var(--color-foreground);
    font-weight: 600;
  }

  .prose-content :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
  }

  .prose-content :global(ul),
  .prose-content :global(ol) {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
    color: var(--color-muted-foreground);
  }

  .prose-content :global(li) {
    margin-bottom: 0.5rem;
  }

  .prose-content :global(blockquote) {
    border-left: 3px solid var(--color-primary);
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: var(--color-muted-foreground);
  }
</style>

<script is:inline>
  // =============================================================================
  // Sistema de valoración por estrellas + Sistema de Roles
  // =============================================================================

  // -- Roles data (replicated from roles.ts for client-side) --
  var ROLES = [
    { name: 'Novato', minPoints: 0, color: 'text-gray-600 dark:text-gray-400', bgColor: 'bg-gray-100 dark:bg-gray-800' },
    { name: 'Aficionado', minPoints: 10, color: 'text-green-600 dark:text-green-400', bgColor: 'bg-green-100 dark:bg-green-900/30' },
    { name: 'Entusiasta', minPoints: 25, color: 'text-blue-600 dark:text-blue-400', bgColor: 'bg-blue-100 dark:bg-blue-900/30' },
    { name: 'Experto', minPoints: 50, color: 'text-amber-600 dark:text-amber-400', bgColor: 'bg-amber-100 dark:bg-amber-900/30' },
    { name: 'Leyenda', minPoints: 100, color: 'text-red-600 dark:text-red-400', bgColor: 'bg-red-100 dark:bg-red-900/30' },
  ];

  function getCurrentRole(points) {
    var sortedRoles = ROLES.slice().sort(function(a, b) { return b.minPoints - a.minPoints; });
    return sortedRoles.find(function(role) { return points >= role.minPoints; }) || ROLES[0];
  }

  function getUserStats() {
    try {
      var stats = JSON.parse(localStorage.getItem('zonaresenas_user_stats') || '{}');
      return {
        points: stats.points || 0,
        commentsCount: stats.commentsCount || 0,
        ratingsCount: stats.ratingsCount || 0,
        username: stats.username || 'Usuario',
      };
    } catch (e) {
      return { points: 0, commentsCount: 0, ratingsCount: 0, username: 'Usuario' };
    }
  }

  function saveUserStats(stats) {
    localStorage.setItem('zonaresenas_user_stats', JSON.stringify(stats));
  }

  function updateRoleBadge() {
    var stats = getUserStats();
    var role = getCurrentRole(stats.points);
    var badge = document.getElementById('current-role-badge');
    if (badge) {
      badge.textContent = role.name + ' (' + stats.points + ' pts)';
      badge.className = 'badge ' + role.bgColor + ' ' + role.color;
    }
  }

  // Init role badge
  updateRoleBadge();

  // -- Star Rating System --
  var selectedRating = 0;
  var starButtons = document.querySelectorAll('.star-btn');
  var ratingDisplay = document.getElementById('rating-display');
  var submitRatingBtn = document.getElementById('submit-rating');
  var ratingFeedback = document.getElementById('rating-feedback');

  starButtons.forEach(function(btn) {
    var value = parseInt(btn.getAttribute('data-value'));

    btn.addEventListener('mouseenter', function() {
      highlightStars(value);
    });

    btn.addEventListener('mouseleave', function() {
      highlightStars(selectedRating);
    });

    btn.addEventListener('click', function() {
      selectedRating = value;
      highlightStars(value);
      ratingDisplay.textContent = value + ' de 10';
      submitRatingBtn.disabled = false;
    });
  });

  function highlightStars(count) {
    starButtons.forEach(function(btn) {
      var val = parseInt(btn.getAttribute('data-value'));
      if (val <= count) {
        btn.classList.remove('star-empty');
        btn.classList.add('star-filled');
      } else {
        btn.classList.remove('star-filled');
        btn.classList.add('star-empty');
      }
    });
  }

  if (submitRatingBtn) {
    submitRatingBtn.addEventListener('click', function() {
      if (selectedRating > 0) {
        var stats = getUserStats();
        stats.ratingsCount = (stats.ratingsCount || 0) + 1;
        stats.points = (stats.points || 0) + 3;
        saveUserStats(stats);

        var role = getCurrentRole(stats.points);
        ratingFeedback.classList.remove('hidden');
        ratingFeedback.innerHTML = '<span class="text-green-600 dark:text-green-400">Valoracion enviada: ' + selectedRating + '/10. +3 puntos. Rango actual: <strong>' + role.name + '</strong> (' + stats.points + ' pts)</span>';

        submitRatingBtn.disabled = true;
        submitRatingBtn.textContent = 'Valoracion enviada';
        updateRoleBadge();
      }
    });
  }

  // -- Comment Form with Validation --
  var commentForm = document.getElementById('comment-form');
  var commentName = document.getElementById('comment-name');
  var commentContent = document.getElementById('comment-content');
  var nameError = document.getElementById('name-error');
  var contentError = document.getElementById('content-error');
  var commentFeedback = document.getElementById('comment-feedback');

  // Regex patterns for validation
  var nameRegex = /^[a-zA-ZáéíóúñÁÉÍÓÚÑüÜ\s]{2,50}$/;
  var contentRegex = /^[\s\S]{10,1000}$/;

  function validateField(input, regex, errorEl, errorMsg) {
    var value = input.value.trim();
    if (!value) {
      errorEl.textContent = 'Este campo es obligatorio.';
      errorEl.classList.remove('hidden');
      input.classList.add('border-red-500');
      return false;
    }
    if (!regex.test(value)) {
      errorEl.textContent = errorMsg;
      errorEl.classList.remove('hidden');
      input.classList.add('border-red-500');
      return false;
    }
    errorEl.classList.add('hidden');
    input.classList.remove('border-red-500');
    return true;
  }

  // Real-time validation
  if (commentName) {
    commentName.addEventListener('input', function() {
      validateField(commentName, nameRegex, nameError, 'Solo se permiten letras y espacios (2-50 caracteres).');
    });
  }

  if (commentContent) {
    commentContent.addEventListener('input', function() {
      validateField(commentContent, contentRegex, contentError, 'El comentario debe tener entre 10 y 1000 caracteres.');
    });
  }

  if (commentForm) {
    commentForm.addEventListener('submit', function(e) {
      e.preventDefault();

      var isNameValid = validateField(commentName, nameRegex, nameError, 'Solo se permiten letras y espacios (2-50 caracteres).');
      var isContentValid = validateField(commentContent, contentRegex, contentError, 'El comentario debe tener entre 10 y 1000 caracteres.');

      if (isNameValid && isContentValid) {
        // Add points for comment
        var stats = getUserStats();
        stats.commentsCount = (stats.commentsCount || 0) + 1;
        stats.points = (stats.points || 0) + 5;
        stats.username = commentName.value.trim();
        saveUserStats(stats);

        var role = getCurrentRole(stats.points);

        // Render new comment in the DOM
        var commentsList = document.getElementById('comments-list');
        var emptyMsg = commentsList.querySelector('p.text-center');
        if (emptyMsg) emptyMsg.remove();

        var today = new Date().toISOString().split('T')[0];
        var initial = commentName.value.trim().charAt(0).toUpperCase();

        var newComment = document.createElement('div');
        newComment.className = 'bg-card border border-border rounded-xl p-5 comment-item';
        newComment.innerHTML =
          '<div class="flex items-center justify-between mb-3">' +
            '<div class="flex items-center gap-2">' +
              '<div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-sm font-bold text-primary font-sans">' + initial + '</div>' +
              '<div>' +
                '<span class="text-sm font-semibold text-foreground font-sans">' + commentName.value.trim() + '</span>' +
                ' <span class="badge ' + role.bgColor + ' ' + role.color + ' text-xs ml-1">' + role.name + '</span>' +
                '<time class="block text-xs text-muted-foreground font-sans">' + today + '</time>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<p class="text-sm text-muted-foreground leading-relaxed">' + commentContent.value.trim().replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>';

        commentsList.insertBefore(newComment, commentsList.firstChild);

        // Reset form
        commentForm.reset();

        // Show feedback
        commentFeedback.classList.remove('hidden');
        commentFeedback.innerHTML = '<span class="text-green-600 dark:text-green-400">Comentario publicado. +5 puntos. Rango actual: <strong>' + role.name + '</strong> (' + stats.points + ' pts)</span>';

        updateRoleBadge();
      }
    });
  }
</script>
